<!DOCTYPE html>
<html lang="en">
  <head>
    <title>web-presentations - <%= topic %></title>
    <link href="/3rdparty/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/stylesheets/style.css" rel="stylesheet">
  </head>
  <body>
    <div class="navbar">
      <div class="navbar-inner" align="center">
        <% if (presenter) { %>   
        <div class="row">
          <div class="btn-group">
            <button class="btn btn-inverse" id="prevBtn"><i class="icon-step-backward icon-white"></i></button>
            <button class="btn btn-inverse" id="nextBtn"><i class="icon-step-forward icon-white"></i></button>
            <button class="btn btn-inverse" id="presentationInfoBtn"><i class="icon-info-sign icon-white"></i></button>  
          </div>    
        </div>
        <% } %>
      </div>
    </div>
    <div class="container">      
      <span>Page: <span id="page_num"></span> / <span id="page_count"></span></span>
      <div class="row" align="center">
        <canvas id="presentationCanvas" style="border:1px solid black; background-color: #fff;"></canvas>
      </div>
    </div>
    <footer class="footer">
      <div class="container" align="center">
        <p>&copy; <a href="#">codemaniac</a>, 2012</p>
      </div>
    </footer>    
    <% if (presenter) { %>  
    <!-- Presentation URL modal -->
    <div class="modal hide fade" id="urlModal">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Presentation Details</h3>
      </div>
      <div class="modal-body">
        <p>Presentation ID:</p>
        <h5><%= id %></h5>
        <br />
        <p>Share this link:</p>
        <h5 id="presentationLink"></h5>
      </div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
      </div>
    </div>
    <% } %>
    <!-- Le some HTML5 shim for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 10]>
      <script type="text/javascript" src="/3rdparty/html5.js"></script>
      <script type="text/javascript" src="/3rdparty/excanvas.compiled.js"></script>
    <![endif]--> 
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script src="/3rdparty/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/3rdparty/pdfjs/pdf.js"></script>
    <script type="text/javascript" src="/3rdparty/pdfjs/compatibility.js"></script>  
    <script type="text/javascript">
      $(document).ready(function(){
        var loc = document.location.href;
        loc = loc.substr(0, loc.lastIndexOf('/')); 
        var presentationID = "<%= id %>";
        <% if (presenter) { %>         
        $("#presentationLink").html(loc + '/' + presentationID);
        $('#urlModal').modal('show');
        $('#presentationInfoBtn').click(function(){
          $('#urlModal').modal('show');
        });
        $('#prevBtn').click(function(){
          socket.emit('previous');
        });
        $('#nextBtn').click(function(){
          socket.emit('next');
        });
        <% } %>       
        var socket = io.connect(loc);
        socket.on('connect', function(){
          socket.emit('attend_presentation', {presentationID : presentationID});
        });
        socket.on('next_slide', function (data) {
          if (pageNum >= pdfDoc.numPages)
          return;
          pageNum++;
          renderPage(pageNum);
        });
        socket.on('previous_slide', function (data) {
          if (pageNum <= 1)
            return;
          pageNum--;
          renderPage(pageNum);
        });
        var url = loc+"/uploads/<%= presentationFileName %>";
        PDFJS.disableWorker = true;
        var pdfDoc = null,
            pageNum = <%= pgno %>,
            scale = 1.0,
            canvas = document.getElementById('presentationCanvas'),
            ctx = canvas.getContext('2d');
        function renderPage(num) {
          pdfDoc.getPage(num).then(function(page) {
            var viewport = page.getViewport(scale);
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            var renderContext = {
              canvasContext: ctx,
              viewport: viewport
            };
            page.render(renderContext);
          });
          document.getElementById('page_num').textContent = pageNum;
          document.getElementById('page_count').textContent = pdfDoc.numPages;
        }        
        PDFJS.getDocument(url).then(function getPdfHelloWorld(_pdfDoc) {
          pdfDoc = _pdfDoc;
          renderPage(pageNum);
        });
      });
    </script>  
  </body>
</html>
